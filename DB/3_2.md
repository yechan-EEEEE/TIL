# **SSAFY Django 댓글/대댓글 기능 구현 요약 (Django Comment/Reply Implementation)**

이 문서는 Django 웹 프레임워크를 활용하여 게시글에 \*\*댓글(Comment)\*\*과 \*\*대댓글(Reply)\*\*을 달 수 있는 기능을 구현하기 위한 Model 설계, View 로직, 그리고 Template 구현 방법을 자세히 정리합니다.

## **1\. Django Model 설계 (models.py)**

계층적인 댓글 구조를 구현하기 위해 기존 SQL 설계(groupId, parentId, depth)를 Django Model로 정의합니다.

### **Comment Model 정의**

from django.db import models

class Comment(models.Model):  
    \# 기본 필드  
    content \= models.TextField()  
    created\_at \= models.DateTimeField(auto\_now\_add=True)

    \# 1\. 관계 필드 (Foreign Key)  
    article \= models.ForeignKey('articles.Article', on\_delete=models.CASCADE)  
    user \= models.ForeignKey('accounts.User', on\_delete=models.CASCADE)

    \# 2\. 계층 구조 구현을 위한 핵심 필드  
    \# 자기 참조 필드: 대댓글인 경우 부모 댓글(Comment)을 참조  
    parent \= models.ForeignKey(  
        'self', on\_delete=models.SET\_NULL, null=True, blank=True  
    )  
    \# 댓글 그룹 ID: 원 댓글과 그에 속한 모든 대댓글은 같은 groupId를 가짐  
    group\_id \= models.IntegerField(default=0)  
    \# 댓글의 깊이: 원 댓글(0), 1차 대댓글(1), ...  
    depth \= models.IntegerField(default=0)

    \# 정렬 기준: groupId 기준 오름차순, groupId가 같으면 id 기준 오름차순  
    class Meta:  
        ordering \= ('group\_id', 'id',)

    def \_\_str\_\_(self):  
        return f'{self.id} \- {self.content\[:10\]}'

## **2\. 댓글 생성 View 로직 (views.py)**

댓글 생성은 주로 POST 요청으로 처리됩니다. 특히 **원 댓글**을 생성할 때 group\_id를 삽입된 댓글의 id와 동일하게 설정하는 로직이 필요합니다.

### **1\. 원 댓글 생성 로직**

원 댓글(parent=None)을 생성할 경우, 객체를 먼저 저장한 후(DB에 id가 할당됨), 그 id 값을 group\_id에 할당하고 다시 저장(save())해야 합니다.

\# articles/views.py (가정)

\# 원 댓글 생성 처리  
if request.method \== 'POST':  
    form \= CommentForm(request.POST)  
    if form.is\_valid():  
        comment \= form.save(commit=False)  
        comment.article \= article \# 현재 게시글  
        comment.user \= request.user \# 현재 로그인 유저  
        comment.depth \= 0  
        comment.parent \= None \# 원 댓글이므로 부모 없음  
          
        \# 1차 저장: id가 할당됨  
        comment.save()

        \# 2차 업데이트: group\_id를 자신의 id와 동일하게 설정 (핵심\!)  
        comment.group\_id \= comment.id  
        comment.save()  
          
        return redirect('articles:detail', article.pk)

### **2\. 대댓글 생성 로직**

대댓글을 생성할 때는 부모 댓글 객체를 참조하고, 부모 댓글의 group\_id와 depth를 물려받아 depth만 1 증가시킵니다.

\# articles/views.py (대댓글 생성 시 로직 일부)

\# parent\_id를 POST 데이터나 URL에서 얻어왔다고 가정  
try:  
    parent\_comment \= Comment.objects.get(pk=parent\_id)  
      
    comment.parent \= parent\_comment             \# 부모 댓글 설정  
    comment.group\_id \= parent\_comment.group\_id \# 부모의 group\_id 상속  
    comment.depth \= parent\_comment.depth \+ 1   \# 깊이 증가  
      
    comment.save()  
      
except Comment.DoesNotExist:  
    \# 부모 댓글이 없는 경우 처리  
    pass

## **3\. 댓글 목록 출력 (template.html)**

템플릿에서는 depth 필드를 활용하여 댓글의 깊이에 따라 시각적인 들여쓰기를 적용함으로써 계층 구조를 표현합니다.

### **댓글 목록 순회 및 시각화**

\<\!-- articles/detail.html (가정) \--\>

{% for comment in comments %}  
    \<div class="comment-item" style="margin-left: {{ comment.depth | stringformat:'s' }}em;"\>   
        \<\!--  
            margin-left: comment.depth \* 2em 등으로 설정하여 들여쓰기 적용  
            (예: depth 0 \-\> 0em, depth 1 \-\> 2em, depth 2 \-\> 4em)  
        \--\>  
          
        \<p\>\<strong\>{{ comment.user.username }}\</strong\> \<span\>| {{ comment.created\_at|date:"Y.m.d H:i" }}\</span\>\</p\>  
        \<p\>{{ comment.content }}\</p\>  
          
        {% if user.is\_authenticated %}  
            \<\!-- 대댓글 작성 폼 버튼/링크 (parent\_id를 넘겨야 함) \--\>  
            \<button onclick="toggleReplyForm({{ comment.id }})"\>답글\</button\>  
        {% endif %}

        \<\!-- 대댓글 작성 폼 (JS로 토글) \--\>  
        \<div id="reply-form-{{ comment.id }}" style="display: none;"\>  
            \<\!-- 대댓글 Form Action은 parent\_id를 포함하도록 설계 필요 \--\>  
            \<\!-- ... CommentForm for reply ... \--\>  
        \</div\>

    \</div\>  
{% endfor %}

## **4\. 핵심 정리 및 주의사항**

| 구분 | 로직 | 설명 |
| :---- | :---- | :---- |
| **Model** | parent \= ForeignKey('self', ...) | 대댓글 구조를 위한 자기 참조 필드 사용 |
| **원 댓글 INSERT** | 2단계 저장 (save() \-\> group\_id 업데이트 \-\> save()) | id 할당 후, 그 id를 group\_id로 재할당하는 과정이 필수 |
| **대댓글 INSERT** | group\_id와 depth 상속 | 부모 댓글의 group\_id를 그대로 사용하고, depth만 \+1 증가 |
| **댓글 조회** | ORDER BY ('group\_id', 'id') | 템플릿에서 계층 구조를 올바르게 표시하기 위한 필수 정렬 조건 |
| **Template** | style="margin-left: {{ comment.depth }}em;" | depth 필드 값을 시각적 들여쓰기에 활용 |

